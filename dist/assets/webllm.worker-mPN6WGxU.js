const m="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.79/lib/index.js";let o=null,a=null;function e(t){postMessage({type:"log",text:t})}function i(t){postMessage({type:"progress",progress:t})}function f(t){postMessage({type:"webgpu",status:t})}function l(t){postMessage({type:"response_final",text:t})}async function y(){try{const t=!!self.navigator?.gpu;return f(t?"WebGPU available":"WebGPU not available, will fallback to WASM"),t}catch{return f("WebGPU check error"),!1}}self.addEventListener("message",async t=>{const r=t.data;if(r.type==="init"){e("Worker init started"),i(.02),await y();try{const s=await import(m);e("WebLLM module loaded from CDN"),i(.05);const{CreateMLCEngine:n,prebuiltAppConfig:d,version:u}=s;e("webllm.version: "+(u||"unknown")),a=d||{},a.useIndexedDBCache=!0;const c=a.model_list||[],p=c.length?c[0].model_id||c[0].model:null;if(!p){e("No prebuilt model found in prebuiltAppConfig. Please register a model in appConfig."),i(1);return}e("Selected model: "+p),o=await n(p,{appConfig:a,initProgressCallback:g=>{i(g.progress??0),g.message&&e("init: "+g.message)}}),e("Engine initialized"),i(1),postMessage({type:"ready"})}catch(s){e("Failed to load or init WebLLM: "+String(s)),i(1),postMessage({type:"ready"})}}else if(r.type==="prompt"){const s=r.prompt;if(e("Received prompt (length "+String(s.length)+")"),!o){e("Engine not ready, attempting init again"),await self.postMessage({type:"log",text:"Engine not ready"});return}try{if(typeof o.createChatCompletion=="function"){const n=await o.createChatCompletion({messages:[{role:"user",content:s}]});n?.text&&l(n.text);return}if(typeof o.request=="function"){const n=await o.request({messages:[{role:"user",content:s}]});l(n?.text||JSON.stringify(n));return}e("Unknown engine API. Keys: "+Object.keys(o||{}).join(", ")),l("Unknown engine API - check console for keys.")}catch(n){e("Inference error: "+String(n)),l("Inference error: "+String(n))}}else if(r.type==="clearCache")try{o?.clearCache&&await o.clearCache(),e("Cleared engine cache (if supported)")}catch(s){e("clearCache failed: "+s)}});
